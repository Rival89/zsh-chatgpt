#!/usr/bin/env zsh

# Main CLI for zsh-chatgpt

set -euo pipefail

script_dir=${0:A:h}
source "$script_dir/../config/config.zsh"
source "$script_dir/../utils/ui.zsh"


usage() {
  cat <<'EOF'
Usage: chatgpt [options] [prompt]

Options:
  -m, --model <name>      Select model (default: $OPENAI_MODEL)
  --session <name>        Use existing session
  --new-session <name>    Create and switch to a new session
  --list                  List available sessions
  --clear                 Clear current session conversation
  --image                 Generate image instead of chat completion
  --file <path>           Include file contents as context
  --cmd <command>         Include command output as context
  --pipe                  Read additional context from STDIN

  "stream": true,
  "messages": $(cat "$session_file")
}
EOF

  append_message "assistant" "$buffer" "$session_file"
  log_turn "$session" "$user_msg" "$buffer"
}

# Image generation -----------------------------------------------

image_request() {

{
  "model": "$OPENAI_IMAGE_MODEL",
  "prompt": "$prompt"
}
EOF

  done
  [[ -n $resp ]] || { echo 'Error contacting OpenAI API' >&2; return 1; }
  echo "$resp" | jq -r '.data[0].url'
}


# Entry -----------------------------------------------------------

if [[ -n $prompt || $from_pipe || -n $file || -n $cmd ]]; then
  handle_message "$prompt"
else
  interactive_loop
fi

